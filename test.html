<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux/WASM Kernel Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        #terminal {
            background: #000;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 15px;
            min-height: 400px;
            overflow-y: auto;
        }
        .log {
            color: #4ec9b0;
        }
        .error {
            color: #f48771;
        }
        .success {
            color: #4fc1ff;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #005a9e;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            background: #252526;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Linux Kernel in WebAssembly</h1>
    <div id="status">Status: Not loaded</div>
    <button onclick="loadKernel()">Load Kernel</button>
    <button onclick="startKernel()">Start Kernel</button>
    <button onclick="clearTerminal()">Clear</button>
    
    <div id="terminal"></div>
    
    <!-- X11 Display -->
    <div style="margin-top: 10px; padding: 10px; background: #252526; border-radius: 3px;">
        <div style="color: #4ec9b0; margin-bottom: 5px;">X11 Display:</div>
        <canvas id="x11-canvas" style="width: 100%; max-width: 1920px; height: 600px; background: #000; border: 1px solid #333;"></canvas>
    </div>
    
    <div style="margin-top: 10px; padding: 10px; background: #252526; border-radius: 3px;">
        <div style="color: #4ec9b0; margin-bottom: 5px;">Shell Input (type commands here):</div>
        <input type="text" id="shellInput" style="width: 100%; padding: 5px; background: #1e1e1e; color: #d4d4d4; border: 1px solid #333; border-radius: 3px;" 
               placeholder="Type shell commands (echo, pwd, ls, whoami, uname -a, cd, exit)" 
               onkeydown="if(event.key==='Enter') { handleShellCommand(); }">
    </div>

    <script type="module">
        import LinuxWasmHost from './wasm_host.js';
        import X11Server from './x11/x11_server.js';

        let host = null;
        let kernelInstance = null;
        let shellInput = '';
        let x11Server = null;

        window.loadKernel = async function() {
            const terminal = document.getElementById('terminal');
            const status = document.getElementById('status');
            
            try {
                log('Loading WASM kernel module...', 'log');
                status.textContent = 'Status: Loading...';
                
                // Create host first
                host = new LinuxWasmHost();
                
                // Set up shell output callback
                host.setShellOutputCallback((text) => {
                    log(text, 'log');
                });
                
                // Try multiple possible paths for the kernel
                const kernelPaths = [
                    './kernel/linux/vmlinux.wasm',
                    'kernel/linux/vmlinux.wasm',
                    '/kernel/linux/vmlinux.wasm',
                    './vmlinux.wasm',
                    'vmlinux.wasm'
                ];
                
                let kernelPath = null;
                let wasmBytes = null;
                
                for (const path of kernelPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            wasmBytes = await response.arrayBuffer();
                            kernelPath = path;
                            log(`Found kernel at: ${path}`, 'success');
                            break;
                        }
                    } catch (e) {
                        // Try next path
                    }
                }
                
                // Load the compiled kernel WASM module
                if (wasmBytes) {
                    try {
                        const module = await WebAssembly.compile(wasmBytes);
                        kernelInstance = await host.init(module);
                        if (kernelInstance && kernelInstance.exports) {
                            log('Kernel WASM module loaded and initialized!', 'success');
                            log('Available exports: ' + Object.keys(kernelInstance.exports).join(', '), 'log');
                        } else {
                            log('Kernel module loaded but no exports found', 'log');
                            kernelInstance = null;
                        }
                    } catch (error) {
                        log('Error compiling/initializing kernel: ' + error.message, 'error');
                        log('Stack: ' + (error.stack || 'N/A'), 'log');
                        kernelInstance = null;
                    }
                } else {
                    log('Note: vmlinux.wasm not found, using mock mode', 'log');
                    log('To use real kernel: make sure kernel/linux/vmlinux.wasm exists', 'log');
                    kernelInstance = null;
                }
                
                // Load Alpine Linux rootfs if available
                try {
                    const alpineResponse = await fetch('alpine/alpine_rootfs.json');
                    if (alpineResponse.ok) {
                        const alpineRootfs = await alpineResponse.json();
                        await host.integrateAlpineRootfs(alpineRootfs);
                        log('Alpine Linux rootfs integrated!', 'success');
                    }
                } catch (err) {
                    log('Alpine rootfs not available, using basic filesystem', 'log');
                }
                
                // Initialize X11 server
                try {
                    x11Server = new X11Server('x11-canvas');
                    host.x11Server = x11Server; // Store in host for syscall access
                    log('X11 server initialized!', 'success');
                    log('Display: ' + x11Server.getDisplayString(), 'log');
                    
                    // Set DISPLAY environment variable
                    if (host.shellEnv) {
                        host.shellEnv.DISPLAY = x11Server.getDisplayString();
                    }
                    
                    // Create a test window
                    setTimeout(() => {
                        try {
                            const testWindow = x11Server.createWindow(
                                null, 100, 100, 400, 300, 24, 0, 1, {}
                            );
                            x11Server.mapWindow(testWindow);
                            x11Server.fillRectangle(testWindow, 10, 10, 380, 280, 0x333333);
                            x11Server.drawText(testWindow, 20, 30, 'X11 Server Ready!', '16px monospace', 0x00ff00);
                            x11Server.render();
                            log('Test window created!', 'success');
                        } catch (e) {
                            log('Failed to create test window: ' + e.message, 'error');
                        }
                    }, 500);
                } catch (err) {
                    log('X11 server initialization failed: ' + err.message, 'error');
                }
                
                if (!kernelInstance) {
                    // If WASM module wasn't loaded, still initialize host
                    log('Host initialized (mock mode - shell will work)', 'success');
                }
                
                status.textContent = 'Status: Loaded (ready to start)';
            } catch (error) {
                log('Error loading kernel: ' + error.message, 'error');
                log('Note: Make sure kernel/linux/vmlinux.wasm exists', 'log');
                status.textContent = 'Status: Error - ' + error.message;
                
                // Create a mock host for testing without WASM
                host = new LinuxWasmHost();
                host.setShellOutputCallback((text) => {
                    log(text, 'log');
                });
            }
        };

        window.startKernel = function() {
            if (!host) {
                log('Please load the kernel first!', 'error');
                return;
            }
            
            try {
                log('Starting kernel...', 'log');
                
                if (kernelInstance && kernelInstance.exports) {
                    // Real kernel mode
                    if (kernelInstance.exports.wasm_kernel_start) {
                        kernelInstance.exports.wasm_kernel_start();
                        log('Kernel started!', 'success');
                    } else {
                        log('Kernel module loaded but wasm_kernel_start not found', 'log');
                    }
                } else {
                    // Mock mode - just initialize shell
                    log('Starting in mock mode (no WASM kernel)...', 'log');
                }
                
                document.getElementById('status').textContent = 'Status: Running';
                
                // Simulate bash launch after kernel starts
                setTimeout(() => {
                    log('Launching /bin/bash...', 'log');
                    // Create a mock execve call - argv pointing to "/bin/bash"
                    // We'll use the shell directly instead
                    host.launchShell('/bin/bash', null, null);
                }, 1000);
            } catch (error) {
                log('Error starting kernel: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
            }
        };

        // Handle keyboard input for shell
        document.addEventListener('keydown', function(e) {
            if (!host || !host.shellActive) return;
            
            if (e.key === 'Enter') {
                e.preventDefault();
                if (shellInput.trim()) {
                    log('$ ' + shellInput, 'log');
                    host.handleShellInput(shellInput);
                    shellInput = '';
                } else {
                    host.printShellPrompt();
                }
            } else if (e.key === 'Backspace') {
                if (shellInput.length > 0) {
                    shellInput = shellInput.slice(0, -1);
                }
            } else if (e.key.length === 1) {
                shellInput += e.key;
            }
        });

        window.clearTerminal = function() {
            document.getElementById('terminal').innerHTML = '';
        };

        window.handleShellCommand = function() {
            const input = document.getElementById('shellInput');
            const command = input.value.trim();
            input.value = '';
            
            if (host && host.shellActive) {
                // Don't log command here - shell will handle output
                host.handleShellInput(command);
            } else {
                log('Shell not active. Start kernel first!', 'error');
            }
        };

        function log(message, type = 'log') {
            const terminal = document.getElementById('terminal');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // Override console.log to also show in terminal
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.join(' '), 'log');
        };

        log('Linux/WASM Kernel Test Page Ready', 'success');
        log('Click "Load Kernel" to begin', 'log');
    </script>
</body>
</html>
